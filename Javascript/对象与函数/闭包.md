# 闭包

## 什么是闭包？

闭包（Closure）在编程中是一个非常强大且广泛应用的概念。在 JavaScript 中，当一个函数在其本身的作用域链之外被引用时，就创建了一个闭包。

**基本组成**：

1. **内部函数**：定义在外部函数内部的函数。
2. **外部函数的变量**：内部函数可以访问外部函数的变量。

**基本特性**：

- 闭包允许一个函数在声明的作用域之外的地方被调用。
- 闭包能记住并访问其外部作用域的变量，即使外部函数已经执行完毕。

### 示例

```javascript
function outerFunction(outerVariable) {
    // 内部函数，一个闭包
    return function innerFunction(innerVariable) {
        // 在内部函数中使用外部变量
        console.log('Outer Variable: ' + outerVariable);
        console.log('Inner Variable: ' + innerVariable);
    }
}

const newFunction = outerFunction('outside');
newFunction('inside');
```

### 解释

- `outerFunction` 接收一个变量 `outerVariable`，并返回 `innerFunction`。
- `innerFunction` 接收一个变量 `innerVariable`，并在其内部引用 `outerVariable`。
- 虽然 `outerFunction` 执行完毕，其作用域中的 `outerVariable` 通常会在没有引用时被垃圾回收，但是由于 `innerFunction` 引用了 `outerVariable`，它依然存活在内存中。
- 当我们执行 `newFunction('inside')` 时，`innerFunction` 能够访问到 `outerVariable`，即便它在 `outerFunction` 作用域外被执行。

### 用途

闭包的一些常见用途包括：

- **创建私有变量**：使用闭包可以在对象外部隐藏具体实现细节，提供公共 API，实现类似于私有变量的效果。
- **工厂函数**：你可以使用闭包动态创建函数并将它们返回给其他的代码。
- **事件处理**：闭包常用于事件处理和回调，因为它们能提供一个持久的作用域链链接。

闭包是一个非常强大的工具，能在多种上下文中用于实现精巧和高效的代码设计。

## 演示：闭包解决的困境

### 问题描述

考虑一个场景：我们想要创建多个按钮，当点击每个按钮时，它将弹出一个警告，显示按钮的索引。

#### 未使用闭包的代码

让我们先看一下未使用闭包时可能遇到的问题：

```javascript
for (var i = 0; i < 5; i++) {
    var button = document.createElement('button');
    button.innerHTML = 'Button ' + i;
    button.onclick = function() {
        alert('This is button ' + i);
    };
    document.body.appendChild(button);
}
```

**问题**：

这里的问题是，当你点击任何一个按钮，它总是弹出“这是按钮5”，而不是期望的按钮索引。这是因为`var`关键字没有块级作用域，它在循环体外仍然可以访问，当点击事件触发时，`i`已经是5。

#### 使用闭包的解决方案

要解决这个问题，我们可以使用闭包来锁定每个回调函数自己的索引值：

```javascript
for (var i = 0; i < 5; i++) {
    var button = document.createElement('button');
    button.innerHTML = 'Button ' + i;
    
    (function(index) {
        button.onclick = function() {
            alert('This is button ' + index);
        };
    })(i);
    
    document.body.appendChild(button);
}
```

**解决方法**：

在这里，我们使用了一个即时调用函数表达式（IIFE），它创建了一个新的作用域，传递了当前的`i`值，并保存为`index`。这样，每个按钮点击事件都绑定到它自己的`index`值上，解决了上述问题。

这个例子演示了闭包如何帮助我们锁定特定的作用域，并保存变量的当前状态。希望这个例子有助于理解闭包以及它们在解决某些类型的问题上的价值！

> 引申：这个问题如果将for循环的var改为let也能解决，在现代JavaScript编程中，通常推荐使用let和const来声明变量，因为它们的作用域更加可预测和易于理解。

## 比喻法：加深理解
<div align=center><img src="img/20231009064411.png" width="60%"></div>

想象一下你正在读一本图书馆的书。这本书中有一个特殊的书签，它不仅记录了你读到哪一页，还记录了你在这一页上有哪些心得和注解。

现在，即使你把这本书还回图书馆，你仍然保留了那个特殊的书签。过了一段时间，你再次借阅这本书，虽然书中的内容对所有人都是一样的，但只有你拥有那个特殊的书签，你可以准确地找到你之前阅读的位置，并查看自己之前的心得和注解。

在这个比喻中：
- 图书馆的书代表一个函数。
- 特殊的书签代表闭包，它不仅可以记住函数的位置（即执行上下文），还可以存储与这个函数相关的特定信息（即局部变量）。
- 你代表执行这个函数的环境。
- 即使函数执行完毕（即书被还回图书馆），闭包依然保留了函数的局部变量和状态（即书签仍然保留了你的心得和注解）。

这样，通过书和书签的比喻，我们可以理解闭包如何允许函数记住并访问其词法作用域，即使该函数在其词法作用域之外执行。

## 小剧场

### 场景：咖啡店

**场地：** 一家咖啡店里，服务员、咖啡师傅和老板在忙碌着。

---

**剧场一：** 不使用闭包 🤯

---

**服务员（Tom）**：😥 噢，我记不清每个客人定制的咖啡都有什么要求了！所有的订单都混在一起，我得一个个重新确认...

**咖啡师傅（Jerry）**：🤔 Tom，你确定这个订单是要加两勺糖，还是三勺？我看着这里好像有点不对。

**老板（Lucy）**：😡 这样下去我们会失去客人的！我们必须找到一个办法来改进我们的服务质量和效率！

---

**剧场二：** 使用闭包 😇

---

**服务员（Tom）**：😌 我为每个订单创建了一个私人小助手（闭包），他能记住每个订单的细节，这样我就不会混淆不同的订单了！

**咖啡师傅（Jerry）**：😄 太好了Tom！现在每个订单我都清清楚楚，知道每一杯咖啡的具体要求。我可以更加准确快速地制作咖啡了！

**老板（Lucy）**：🎉 优秀！我们的客人现在都对我们的服务赞不绝口。看来这个小助手（闭包）真是我们的得力助手啊！

---

**总结**

- 在**剧场一**中，没有一个好的管理系统来处理每个客人的订单，信息容易混淆，这就可能导致给客人带来不好的体验（不使用闭包时，函数外的变量在多次调用间无法保存状态，容易导致数据的混乱或不准确）。

- 在**剧场二**中，利用闭包的特性，Tom能够为每个订单创建一个独立的执行环境，每个环境都保存了相应订单的信息，并且这些信息不会与其他订单混淆（使用闭包可以让变量的值在多次调用间保持，每次调用都能引用到相应的上下文环境，使数据管理更加精确和便利）。

希望这个小剧场让闭包的概念在你的脑海里更加形象生动！🎭🎨