# async和defer

`async` 和 `defer` 是 HTML `<script>` 标签的两个属性，它们都用于改变外部脚本（即使用 `src` 属性引入的脚本）在 HTML 页面中的加载和执行行为。它们的作用和区别如下：

### 1. `async`

当脚本添加了 `async` 属性：

```html
<script async src="script.js"></script>
```

- **非阻塞**：脚本的加载不会阻塞 HTML 的解析，两者会并行进行。
- **执行时机**：一旦脚本加载完成，HTML 解析会被暂停，以便脚本可以立即执行，然后 HTML 解析会继续进行。
- **执行顺序**：如果页面中有多个 `async` 脚本，不能保证它们的执行顺序。

### 2. `defer`

当脚本添加了 `defer` 属性：

```html
<script defer src="script.js"></script>
```

- **非阻塞**：脚本的加载不会阻塞 HTML 的解析，两者会并行进行。
- **执行时机**：脚本会在 HTML 解析完成后，DOMContentLoaded 事件触发之前执行。
- **执行顺序**：如果页面中有多个 `defer` 脚本，它们会按照在 HTML 中出现的顺序执行。

### 3. 对比和选择

- 如果脚本之间存在依赖关系，通常选择 `defer`，因为它保证了脚本的执行顺序。
- 如果脚本之间完全独立，`async` 可能是一个更好的选择，因为首个脚本加载并执行的时机可能会更早。

### 注意

- `async` 和 `defer` 仅适用于外部脚本（有 `src` 属性的 `<script>` 标签）。
- 在没有 `async` 和 `defer` 的情况下，脚本是同步加载的，即脚本会阻塞 HTML 解析，等脚本加载和执行完毕后，HTML 解析才会继续。
- 如果同时使用 `async` 和 `defer`，`async` 属性将会优先生效。不过，实际使用中一般不会同时使用这两个属性。

## 类比法

> async和defer这两个关键词的作用类似于Android中在子线程中执行耗时任务，然后在主线程中更新UI吗？

`async` 和 `defer` 关键词在一定程度上与在 Android 开发中的处理异步操作的原理类似，但具体的使用上和效果还是有一些区别的。

在 Android 开发中，通常我们会在一个子线程（比如使用 AsyncTask、Handler 或者 RxJava）中执行耗时任务（如网络请求、数据库操作等），以防止UI线程被阻塞。然后，在耗时任务执行完成后，我们通常会回到主线程来更新UI。这是因为 Android 不允许在子线程中更新UI，以防止可能的线程安全问题。

而在 JavaScript 中使用 `async` 和 `defer` 的情况是这样的：

- 当我们在 `script` 标签上使用 `async` 关键词时，它告诉浏览器立即下载文件，并在可能的情况下同时继续解析HTML文档。一旦脚本下载完成，HTML文档的解析将被暂停，以便脚本可以被执行，然后解析将继续。

- 使用 `defer` 关键词也会让浏览器立即下载文件，但它会保证在整个文档解析完毕之后再执行脚本。这意味着使用 `defer` 的脚本会按照它们在文档中的出现顺序被执行。

在这两种情况下，JavaScript 脚本的加载都是异步的，这点的确与在 Android 中的异步处理类似。但需要注意的是，`async` 和 `defer` 主要用于控制脚本的加载和执行的时间，并不直接涉及到像 Android 那样的主线程/子线程的概念或者UI更新的问题。

希望这有助于阐明它们之间的异同！🙂🚀🖥️

## 小剧场

**🎭 小剧场：魔法森林的故事**

在一个名为“魔法森林”的迷人之地，居住着三位知名的巫师——Sync🧙‍♂️，Async🧙‍♀️和 Defer🧙‍♂️。他们得知了一个秘密——森林深处有一棵能够实现愿望的魔法树🌳。

---

**Sync🧙‍♂️：** 朋友们，我们必须找到那棵魔法树！我听说它在每个月的满月🌕夜晚才显现！

**Async🧙‍♀️：** 哦，它听起来如此神奇✨！我们当然要去，但我们必须小心，森林里有许多的未知。

**Defer🧙‍♂️：** 的确，我们也要确保森林中的小动物们🦉🦇🐿️不会因我们的探险而受到惊扰。

---

🚶‍♂️ Sync🧙‍♂️ 急切地奔向森林深处...

**Sync🧙‍♂️：** 我将直奔目标，找到魔法树！其他事情等我实现愿望后再说！

🌿 森林中的小动物们和其他生命因Sync🧙‍♂️的匆忙而感到不安，森林的和平被短暂打破。

---

👁️‍🗨️ Async🧙‍♀️ 使用了一个法术，允许她同时保护森林和探险...

**Async🧙‍♀️：** 我将分身探险🚶‍♀️，而我的本体🧘‍♀️将保持在这里，确保森林的安宁不会受到影响。

🍃 尽管Async🧙‍♀️的分身在探险，她确保森林的平静，并能及时应对突发情况。

---

😌 Defer🧙‍♂️ 静静地走进森林...

**Defer🧙‍♂️：** 我会在所有小动物们安睡后💤，悄悄进行我的探险，这样就不会打扰到他们的生活。

🌜 当森林中的生命们都进入梦乡后，Defer🧙‍♂️默默开始了他的探险，没有打扰到任何生命。

---

在这个小剧场中：
- **Sync🧙‍♂️** 是传统的 `<script>` 加载方式，在他探险的过程中，整个森林的生活被打扰了。
- **Async🧙‍♀️** 使用的方法类似于用 `async` 的`<script>` 标签，她的探险和保护森林的活动是同时进行的，没有完全阻碍森林中的生活。
- **Defer🧙‍♂️** 的行动类似于用 `defer` 的`<script>` 标签，他等到整个森林安静下来，所有的活动完成后，再开始自己的探险。

希望这个故事能帮助你更生动、形象地理解 `sync`、`async` 和 `defer` 的区别与应用！🎭🌲🌕